!   hub.ecs

!   This script tests sending a large file from the hub in response to a request

    script MQTTHub

    use plugin MQTT from ec_mqtt

    topic Request
    topic Response
    variable Query
    variable Text

    init Request
        name `38:54:39:34:62:d7/request`
        qos 1
    init Response
        name `38:54:39:34:62:d7/response`
        qos 1

    mqtt
        id `EasyCoder-MQTT-Hub`
        broker `test.mosquitto.org`
        port 1883
        topics Request
    
    on mqtt message
    begin
        put the mqtt message into Query
        log the mqtt topic cat ` - ` cat Query
        split Query on ` `
        index Query to 0
        if Query is `file`
        begin
            index Query to 1
            load Text from Query
            send mqtt Text to Response
        end
        else send mqtt `Ack` to Response
    end

    stop
