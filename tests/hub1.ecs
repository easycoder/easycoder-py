!   docletHub.ecs

    script DocletHub

    use mqtt
    use plugin Doclets from ec_doclets

    topic Request
    topic Response
    dictionary Doclet
    list List
    variable Query
    variable DocletPath
    variable Name
    variable Text
    variable FilePath
    variable N
    variable P
    
!    debug step

    init Request
        name `a8:41:f4:d3:19:dd/request`
        qos 1
    init Response
        name `a8:41:f4:d3:19:dd/response`
        qos 1

    mqtt
        id `EasyCoder-Doclet-Hub`
        broker `test.mosquitto.org`
        port 1883
        topics Request

    doclets init
    set doclets path `Linux,Doclets,EasyCoder,RBR`
    
    on mqtt message
    begin
        put the mqtt message into Query
        log `Query: ` cat the mqtt topic cat ` - ` cat Query
        put the position of `:` in Query into P
        if left P of Query is `path`
        begin
            increment P
            put from P of Query into DocletPath
            set doclets path to DocletPath
        end
        else if left P of Query is `file`
        begin
            increment P
            put from P of Query into Name
            load Text from Name
            send mqtt Text to Response
        end
        else
        begin
            get List from doclet query Query
            if the count of List is 0 log `No results`
            else log `Sending results`
!            else begin
!                log `Results: ` cat List
!            end
            send mqtt List to Response
        end
    end

    stop
