!   hub.ecs

!   This script tests sending a large file from the hub in response to a request

    script MQTTHub

    use mqtt

    topic Request
    topic Response
    variable Query
    variable Name
    variable Text
    variable P
    
!    debug step

    init Request
        name `a8:41:f4:d3:19:dd/request`
        qos 1
    init Response
        name `a8:41:f4:d3:19:dd/response`
        qos 1

    mqtt
        id `EasyCoder-MQTT-Hub`
        broker `test.mosquitto.org`
        port 1883
        topics Request
    
    on mqtt message
    begin
        put the mqtt message into Query
!        log the mqtt topic cat ` - ` cat Query
        put the position of `:` in Query into P
        if left P of Query is `file`
        begin
            increment P
            put from P of Query into Name
            load Text from Name
            send mqtt Text to Response
        end
        else send mqtt `Ack` to Response
    end

    stop
